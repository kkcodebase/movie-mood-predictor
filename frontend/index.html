<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>MoodPlay+ (Lite)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="text-center mb-4">ðŸŽ¬ MoodPlay+ (Lite)</h1>

  <div class="card shadow-sm p-3 mb-4">
    <h4>Analyze a Movie Review</h4>
    <input id="username" class="form-control mb-2" placeholder="Username (e.g., guest)">
    <input id="movie" class="form-control mb-2" placeholder="Movie name">
    <textarea id="review" class="form-control mb-2" rows="4" placeholder="Paste a short review here"></textarea>
    <button class="btn btn-primary" onclick="analyze()">Analyze</button>
  </div>

  <div id="result" class="mb-4"></div>

  <div class="card shadow-sm p-3">
    <h4>Your Watchlist</h4>
    <div class="mb-2">
      <button class="btn btn-success" onclick="viewWatchlist()">View</button>
    </div>
    <ul id="watchlist" class="list-group"></ul>
  </div>
</div>

<script>
  // Set this to your exact API Gateway invoke URL (base stage). Example:
  // const API_URL = "https://8jc4d1odx1.execute-api.us-east-1.amazonaws.com/prod";
  const API_URL = "https://8jc4d1odx1.execute-api.us-east-1.amazonaws.com/prod";

  async function callApi(payload) {
    try {
      // IMPORTANT: do NOT set custom headers here to avoid preflight in many cases.
      const res = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(payload)
      });

      // show raw response status in console
      console.log("HTTP status:", res.status, res.statusText);

      const text = await res.text();
      try {
        return { ok: res.ok, data: JSON.parse(text), raw: text };
      } catch (e) {
        return { ok: res.ok, data: null, raw: text };
      }
    } catch (err) {
      console.error("Network/fetch error:", err);
      return { ok: false, error: String(err) };
    }
  }

  async function analyze() {
    const username = document.getElementById('username').value || 'guest';
    const movie = document.getElementById('movie').value || 'Unknown';
    const review = document.getElementById('review').value || '';

    const resp = await callApi({ username, movie, review, action: 'analyze' });
    console.log("API response:", resp);

    if (!resp.ok) {
      document.getElementById('result').innerHTML = '<div class="alert alert-danger">Request failed. Check console.</div>';
      return;
    }

    const data = resp.data || {};
    let html = `<div class="card p-3 shadow-sm">
      <h5>Sentiment: <span class="badge bg-info">${data.sentiment || '-'}</span></h5>
      <p class="mt-2 mb-1">${data.message || ''}</p>
      <p class="mt-2 mb-1">Recommendations:</p><ul>`;
    (data.recommendations || []).forEach(m => {
      html += `<li class="mb-1">${m}
        <button class="btn btn-sm btn-outline-primary ms-2" onclick="addToWatchlist('${m.replace(/'/g,"\\'")}')">Add</button>
      </li>`;
    });
    html += `</ul></div>`;
    document.getElementById('result').innerHTML = html;
  }

  async function addToWatchlist(movie) {
    const username = document.getElementById('username').value || 'guest';
    const resp = await callApi({ username, movie, action: 'add' });
    console.log("add response:", resp);
    if (resp.ok && resp.data) alert(resp.data.message || "Added");
    else alert("Add failed - check console");
  }

  async function viewWatchlist() {
    const username = document.getElementById('username').value || 'guest';
    const resp = await callApi({ username, action: 'view' });
    console.log("view response:", resp);
    if (!resp.ok) { alert("View failed - check console"); return; }
    const data = resp.data || {};
    const ul = document.getElementById('watchlist');
    ul.innerHTML = '';
    (data.watchlist || []).forEach(m => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = m;
      ul.appendChild(li);
    });
  }
</script>
</body>
</html>
